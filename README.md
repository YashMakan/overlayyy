# Overlayyy - Spotify Mini PIP Player with Realtime Lyrics

Overlayyy is a Chrome extension that provides a Picture-in-Picture (PIP) mini-player for Spotify, enhanced with real-time synchronized lyrics.

## Features

*   **Spotify Mini Player:** Control your Spotify playback in a compact PIP window.
*   **Real-time Lyrics:** Displays synchronized lyrics for the currently playing song.
*   **Chrome Extension:** Integrates directly into your browser.
*   **Flutter-based UI:** The PIP window is built with Flutter.
*   **Separate Lyrics Backend:** A Dart Shelf server fetches lyrics from Musixmatch.

## Folder Structure
```
overlayyy/
├── .env # Holds the Spotify access token (managed by refresh.sh)
├── build.sh # Main build script for the Chrome extension
├── pubspec.yaml # Flutter app's pubspec.yaml
├── README.md # This file
├── refresh.sh # Script to refresh Spotify token, build Flutter app, and then build the extension
├── release_libs/ # Static JS/CSS files for the Chrome extension (content scripts, background)
│
└── lib/ # Flutter application (PIP UI)
   ├── main.dart # Flutter app entry point
   ├── core/ # Core utilities, config, env variables for Flutter app
   ├── data/ # Data layer (models, repositories) for Flutter app
   ├── presentation/ # UI Layer (widgets, cubits/blocs) for Flutter app
   └── api.dart # Main server entry point
```

## Prerequisites

*   **Flutter SDK:** (Check `pubspec.yaml` for version, e.g., `sdk: '>=3.2.5 <4.0.0'`)
*   **Dart SDK:** (Comes with Flutter, also used for the server)
*   **jq:** Command-line JSON processor (install via `brew install jq` on macOS, or `sudo apt-get install jq` on Debian/Ubuntu). Used by `refresh.sh`.
*   **A Spotify Developer Application:** You'll need a Client ID and Client Secret from [Spotify Developer Dashboard](https://developer.spotify.com/dashboard/).
*   **A Spotify Refresh Token:** You need to obtain this once manually (e.g., through an OAuth flow) to use with `refresh.sh`.

## Setup

1.  **Clone the repository:**
    ```bash
    git clone <repository-url>
    cd overlayyy
    ```

2.  **Configure `refresh.sh`:**
    *   Open `refresh.sh`.
    *   Replace the placeholder `SPOTIFY_REFRESH_TOKEN` with your actual Spotify refresh token.
    *   Replace `SPOTIFY_CLIENT_ID` and `SPOTIFY_CLIENT_SECRET` with your credentials from the Spotify Developer Dashboard.

3.  **Configure Lyrics Server (Musixmatch Tokens):**
    *   The lyrics server (`lib/api.dart`) currently has placeholders for Musixmatch tokens:
        ```dart
        // call https://apic-desktop.musixmatch.com/ws/1.1/token.get?app_id="web-desktop-app-v1.0 to update your access token here
        const EXPIRATION_TIME=""; // Should be seconds since epoch for expiration
        const ACCESS_TOKEN="";    // Musixmatch user token
        ```
    *   You need to obtain these from Musixmatch (e.g., by calling the mentioned endpoint).

4.  **Install Dependencies:**
    *   For the Flutter app:
        ```bash
        flutter pub get
        flutter pub run build_runner build --delete-conflicting-outputs
        ```

## Running the Application

1.  **Start the Lyrics Server:**
    ```bash
    dart run lib/api.dart
    ```
    The server will typically start on `http://localhost:8081`.

2.  **Build the Chrome Extension:**
    *   Run the `refresh.sh` script. This script will:
        1.  Fetch a new Spotify access token using your refresh token.
        2.  Update the `.env` file with this new access token.
        3.  Run `flutter clean`.
        4.  Run `flutter pub run build_runner build --delete-conflicting-outputs` for the Flutter app.
        5.  Execute `./build.sh` to compile the Flutter web app and package the extension into the `release/` folder.
    ```bash
    ./refresh.sh
    ```
    Alternatively, if your `.env` file already contains a valid Spotify `ACCESS_TOKEN`, you can run the build script directly:
    ```bash
    ./build.sh
    ```

3.  **Install the Extension in Chrome:**
    *   Open Chrome and navigate to `chrome://extensions`.
    *   Enable "Developer mode" (usually a toggle in the top right).
    *   Click "Load unpacked".
    *   Select the `release/` folder generated by the build script.
    *   The Overlayyy extension icon should appear in your Chrome toolbar.

## How It Works

*   **Authentication:**
    *   The `refresh.sh` script handles Spotify authentication by using a long-lived refresh token to obtain a short-lived access token. This access token is stored in `.env` and used by the Flutter application to make Spotify API calls.
    *   The Flutter app (`SpotifyCubit`) also contains an `authenticate()` method which seems to implement a manual OAuth PKCE flow using `flutter_web_auth_2`. This might be for an initial setup or an alternative login path. The `AppConfiguration` class in `lib/core/config/` seems related but isn't fully initialized/utilized in the current Cubit setup for this flow.
*   **Flutter App:**
    *   The `lib/` directory contains the Flutter application that renders the PIP UI.
    *   It uses `SpotifyCubit` for state management, fetching the currently playing song from Spotify and lyrics from the local lyrics server.
*   **Lyrics Server:**
    *   The `server/` directory contains a Dart Shelf server.
    *   Its primary role is to proxy requests for lyrics to the Musixmatch API, handling token management for Musixmatch.
*   **Build Process (`build.sh`):**
    1.  Runs `flutter build web --web-renderer html --csp`.
    2.  Creates a `release/` directory.
    3.  Copies the Flutter web build output (`build/web/*`) to `release/`.
    4.  Copies static assets from `release_libs/` (content scripts, background scripts, CSS) to `release/`.
    5.  Extracts `serviceWorkerVersion` from the `index.html` generated by Flutter.
    6.  Overwrites `release/index.html` with a custom template, injecting necessary scripts.
    7.  Updates the `serviceWorkerVersion` placeholder in `release/release_libs/init0.js`.
    8.  Overwrites `release/manifest.json` with a predefined Chrome extension manifest.

## Development Notes

*   **Hot Reload/Restart:** For changes in the Flutter app, you can use standard Flutter development practices. After making changes, run `./build.sh` (or `./refresh.sh`) to update the extension in the `release/` folder. Then, in `chrome://extensions`, click the "reload" icon for the Overlayyy extension.
*   **Server Development:** For the lyrics server, you can restart it after making changes.
*   **Musixmatch Token:** Remember to periodically update the Musixmatch token in `server/bin/server.dart` or implement a more robust token management solution (e.g., automated refresh or loading from environment variables).

## Known Issues / TODOs

*   **Spotify Authentication in Cubit:** The `SpotifyCubit.authenticate()` method relies on `state.configuration` which is not initialized, so this flow might not work as intended without further setup.
*   **Hardcoded Secrets:**
    *   `refresh.sh` contains hardcoded Spotify Client ID, Secret, and Refresh Token. These should be externalized (e.g., via environment variables).
    *   `api.dart` has placeholders for Musixmatch tokens that are meant to be hardcoded. These should be managed via environment variables or a secure configuration method.
*   **Polling Interval:** The `pollingTimer` in `lib/main.dart` polls every 1.5 seconds. Consider if this is optimal or if Spotify's Web Playback SDK (if applicable for extensions) or other event-driven methods could be used.